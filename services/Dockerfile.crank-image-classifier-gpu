# Use standard Python base image (will fall back gracefully without GPU)
FROM python:3.11-slim

# Create non-root user
RUN addgroup --gid 1000 worker && \
    adduser --uid 1000 --gid 1000 --disabled-password worker

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    libgl1-mesa-dev \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY services/requirements-universal-gpu.txt .

# Install dependencies with better error handling and proper CUDA support
# First install PyTorch with CUDA support (matching host environment)
RUN pip install --no-cache-dir --timeout=300 \
    torch==2.5.1+cu121 torchvision==0.20.1+cu121 torchaudio==2.5.1+cu121 \
    --index-url https://download.pytorch.org/whl/cu121 \
    || (echo "âŒ CUDA PyTorch installation failed - falling back to CPU version" && \
        pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu)

# Then install other ML dependencies
RUN pip install --no-cache-dir ultralytics opencv-python GPUtil psutil pillow numpy \
    fastapi uvicorn httpx aiohttp pydantic python-multipart PyYAML structlog

# Copy service files
COPY services/crank_image_classifier.py ./crank_image_classifier_simple.py

# Copy GPU manager dependency (required for UniversalGPUManager)
COPY src/gpu_manager.py ./

# Copy certificate initialization script (needed for in-process initialization)
COPY services/crank_cert_initialize.py ./scripts/

# Create certificates directory with proper ownership
RUN mkdir -p /etc/certs && chown worker:worker /etc/certs

# Create simplified startup script - NO subprocess initialization
RUN echo '#!/usr/bin/env python3' > run_worker.py && \
    echo '# Simple direct startup - certificate initialization in main()' >> run_worker.py && \
    echo 'import crank_image_classifier_simple' >> run_worker.py && \
    echo 'crank_image_classifier_simple.main()' >> run_worker.py && \
    chmod +x run_worker.py

# Security hardening
USER worker

# Expose worker HTTPS port
EXPOSE 8400

# Health check for HTTPS-only mode
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
    CMD curl -k -f https://localhost:${IMAGE_CLASSIFIER_HTTPS_PORT:-8400}/health || exit 1

# Run simplified startup script
CMD ["python", "run_worker.py"]
