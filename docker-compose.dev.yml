# üõ†Ô∏è TRUE Local Development Configuration
# Docker Compose for LOCAL development - builds from source, no cloud dependencies
# 
# This configuration:
# - Builds all services from local source code
# - No Azure Container Registry dependencies
# - Fast iteration with live code mounting
# - Proper local development workflow

services:
  # Platform Service - Built Locally
  crank-platform:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-platform
    container_name: crank-platform-dev
    ports:
      - "${PLATFORM_PORT:-8000}:${PLATFORM_PORT:-8000}"
      - "${PLATFORM_HTTPS_PORT:-8443}:${PLATFORM_HTTPS_PORT:-8443}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_ENV=local
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PLATFORM_PORT=${PLATFORM_PORT:-8000}
      - PLATFORM_HTTPS_PORT=${PLATFORM_HTTPS_PORT:-8443}
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLATFORM_PORT:-8000}/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - crank-local-net
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Document Converter - Built Locally
  crank-doc-converter:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-doc-converter
    container_name: crank-doc-converter-dev
    ports:
      - "${DOC_CONVERTER_PORT:-8100}:${DOC_CONVERTER_PORT:-8100}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_URL=http://crank-platform:${PLATFORM_PORT:-8000}
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
      - DOC_CONVERTER_PORT=${DOC_CONVERTER_PORT:-8100}
    depends_on:
      crank-platform:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DOC_CONVERTER_PORT:-8100}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - crank-local-net

  # Email Classifier - Built Locally  
  crank-email-classifier:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-email-classifier
    container_name: crank-email-classifier-dev
    ports:
      - "${EMAIL_CLASSIFIER_PORT:-8200}:${EMAIL_CLASSIFIER_PORT:-8200}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_URL=http://crank-platform:${PLATFORM_PORT:-8000}
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
      - EMAIL_CLASSIFIER_PORT=${EMAIL_CLASSIFIER_PORT:-8200}
    depends_on:
      crank-platform:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${EMAIL_CLASSIFIER_PORT:-8200}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - crank-local-net

  # Email Parser - Built Locally
  crank-email-parser:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-email-parser
    container_name: crank-email-parser-dev
    ports:
      - "${EMAIL_PARSER_PORT:-8300}:${EMAIL_PARSER_PORT:-8300}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_URL=http://crank-platform:${PLATFORM_PORT:-8000}
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
      - EMAIL_PARSER_PORT=${EMAIL_PARSER_PORT:-8300}
    depends_on:
      crank-platform:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${EMAIL_PARSER_PORT:-8300}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - crank-local-net

  # Image Classifier - Built Locally (GPU Support)
  crank-image-classifier:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-image-classifier-gpu
    container_name: crank-image-classifier-dev
    ports:
      - "${IMAGE_CLASSIFIER_PORT:-8400}:${IMAGE_CLASSIFIER_PORT:-8400}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_URL=http://crank-platform:${PLATFORM_PORT:-8000}
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
      - IMAGE_CLASSIFIER_PORT=${IMAGE_CLASSIFIER_PORT:-8400}
      - CUDA_VISIBLE_DEVICES=all
    depends_on:
      crank-platform:
        condition: service_healthy

  # Streaming Service - Built Locally
  crank-streaming:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-streaming
    container_name: crank-streaming-dev
    ports:
      - "${STREAMING_PORT:-8500}:${STREAMING_PORT:-8500}"
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    environment:
      - PLATFORM_URL=http://crank-platform:${PLATFORM_PORT:-8000}
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - STREAMING_PORT=${STREAMING_PORT:-8500}
    depends_on:
      crank-platform:
        condition: service_healthy
      crank-email-classifier:
        condition: service_healthy

networks:
  crank-local-net:
    driver: bridge
    name: crank-local-network

# Local development volumes
volumes:
  local-data:
    name: crank-local-data
  local-logs:
    name: crank-local-logs