# Mock Let's Encrypt Test Configuration
# Uses real certificate generation but bypasses domain validation
#
# This allows testing production-style certificates without requiring
# actual domain ownership and internet accessibility

services:
  # Certificate Authority Service (Mock Let's Encrypt)
  cert-authority:
    build:
      context: services
      dockerfile: Dockerfile.cert-authority
    container_name: cert-authority-mock-letsencrypt
    ports:
      - "9090:9090"
    volumes:
      - ./certs-production:/app/certificates
    environment:
      - CERT_PROVIDER=letsencrypt
      - LETSENCRYPT_DOMAIN=crankbird.com
      - LETSENCRYPT_EMAIL=admin@crankbird.com
      - LETSENCRYPT_MOCK=true  # ðŸ§ª Enable mock mode (no domain validation)
      - CERT_DIR=/app/certificates
      - LOG_LEVEL=INFO
      - CRANK_ENVIRONMENT=production-mock-letsencrypt
    networks:
      - crank-net-test
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Platform Service
  platform:
    build:
      context: services
      dockerfile: Dockerfile.platform
    container_name: crank-platform-mock-letsencrypt
    ports:
      - "8443:8443"
    volumes:
      - ./certs-production:/etc/certs:ro
    environment:
      - PLATFORM_ENV=docker
      - CRANK_ENVIRONMENT=production-mock-letsencrypt
      - LOG_LEVEL=INFO
      - PLATFORM_HTTPS_PORT=8443
      - HTTPS_ONLY=true
      - CERT_VALIDATION=strict
      - PLATFORM_AUTH_TOKEN=mock-letsencrypt-key-v1
      - CERT_AUTHORITY_URL=https://cert-authority:9090
    depends_on:
      cert-authority:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--cacert", "/etc/certs/ca.crt", "-f", "https://localhost:8443/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - crank-net-test
    restart: unless-stopped

  # Email Parser Worker
  crank-email-parser:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crank-email-parser-mock-letsencrypt
    volumes:
      - ./mail-archive:/app/mail-archive
      - ./certs-production:/etc/certs:ro
    environment:
      - PLATFORM_URL=https://platform:8443
      - CRANK_ENVIRONMENT=production-mock-letsencrypt
      - LOG_LEVEL=INFO
      - PLATFORM_AUTH_TOKEN=mock-letsencrypt-key-v1
      - CERT_VALIDATION=strict
      - CERT_AUTHORITY_URL=https://cert-authority:9090
    depends_on:
      platform:
        condition: service_healthy
    networks:
      - crank-net-test
    restart: unless-stopped

networks:
  crank-net-test:
    driver: bridge
    name: crank-network-mock-letsencrypt

# Test Instructions:
#
# 1. Start the mock Let's Encrypt environment:
#    docker-compose -f docker-compose.mock-letsencrypt.yml up -d
#
# 2. Verify certificate generation:
#    docker exec cert-authority-mock-letsencrypt curl -k https://localhost:9090/ca/certificate
#
# 3. Check certificate details:
#    docker exec cert-authority-mock-letsencrypt openssl x509 -in /app/certificates/ca.crt -text -noout
#
# 4. Test SSL validation:
#    docker logs crank-email-parser-mock-letsencrypt
#
# This configuration should eliminate SSL warnings while using production-like certificates