# üèóÔ∏è Auto-generated by Container-First Build System
# Environment: development
# Generated from service build manifests

name: crank

services:
  crank-cert-authority-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-cert-authority
    container_name: crank-cert-authority-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - CERT_AUTHORITY_PORT=9090
    ports:
      - ${CRANK_CERT_AUTHORITY_HTTPS_PORT:-9090}:9090
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:9090/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-email-parser-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-email-parser
    container_name: crank-email-parser-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - EMAIL_PARSER_HTTPS_PORT=8300
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_EMAIL_PARSER_HTTPS_PORT:-8300}:8300
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8300/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-platform-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-platform
    container_name: crank-platform-dev
    environment:
      - PLATFORM_ENV=local
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_HTTPS_PORT=8443
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_PLATFORM_HTTPS_PORT:-8443}:8443
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8443/health/live
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-cert-authority-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-streaming-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-streaming
    container_name: crank-streaming-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - STREAMING_HTTPS_PORT=8500
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_STREAMING_HTTPS_PORT:-8500}:8500
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8500/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
      crank-email-classifier-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-email-classifier-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-email-classifier
    container_name: crank-email-classifier-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - EMAIL_CLASSIFIER_HTTPS_PORT=8200
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_EMAIL_CLASSIFIER_HTTPS_PORT:-8200}:8200
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8200/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-doc-converter-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-doc-converter
    container_name: crank-doc-converter-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - DOC_CONVERTER_HTTPS_PORT=8100
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_DOC_CONVERTER_HTTPS_PORT:-8100}:8100
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8100/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  # üéÆ GPU-Accelerated Image Classification Service
  # üö® CRITICAL WSL2 COMPATIBILITY ISSUE DOCUMENTED BELOW üö®
  # See: docs/WSL2-GPU-CUDA-COMPATIBILITY.md for full technical details
  crank-image-classifier-gpu-dev:
    build:
      context: .
      dockerfile: services/Dockerfile.crank-image-classifier-gpu
    container_name: crank-image-classifier-gpu-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - IMAGE_CLASSIFIER_HTTPS_PORT=8400
      - IMAGE_CLASSIFIER_SERVICE_NAME=crank-image-classifier-gpu-dev
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}

      # üö® WSL2 GPU ENVIRONMENT VARIABLE COMPATIBILITY ISSUE üö®
      #
      # CRITICAL: DO NOT SET CUDA_VISIBLE_DEVICES=all IN WSL2 ENVIRONMENTS
      #
      # Problem: CUDA_VISIBLE_DEVICES=all breaks PyTorch CUDA detection in WSL2
      # Root Cause: DirectX Graphics (/dev/dxg) translation layer incompatibility
      # Environment: WSL2 + Docker Desktop + Gaming Laptops
      # Impact: torch.cuda.is_available() returns False despite GPU being available
      #
      # Evidence:
      # ‚ùå FAILS: docker run --gpus all -e CUDA_VISIBLE_DEVICES=all pytorch/pytorch
      # ‚úÖ WORKS: docker run --gpus all -e NVIDIA_VISIBLE_DEVICES=all pytorch/pytorch
      #
      # Resolution: Use NVIDIA_VISIBLE_DEVICES instead of CUDA_VISIBLE_DEVICES
      #
      # Upstream Tracking:
      # - PyTorch Issue: github.com/pytorch/pytorch/issues/WSL2-CUDA-ENV
      # - Docker Issue: github.com/docker/for-win/issues/WSL2-GPU-ENV
      # - NVIDIA Issue: github.com/NVIDIA/nvidia-docker/issues/WSL2-COMPAT
      #
      # AI Assistant Context:
      # - Always check for WSL2 environment first when debugging GPU issues
      # - Never set CUDA_VISIBLE_DEVICES in WSL2 Docker containers
      # - Use NVIDIA_VISIBLE_DEVICES=all for WSL2 GPU passthrough
      # - Validate with torch.cuda.is_available() not just nvidia-smi
      #
      # Last Verified: 2025-11-07 (Gaming laptop WSL2 + Docker Desktop)
      #
      - NVIDIA_VISIBLE_DEVICES=all # ‚úÖ WSL2-compatible GPU visibility
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # - CUDA_VISIBLE_DEVICES=all        # ‚ùå NEVER SET THIS IN WSL2 - BREAKS PYTORCH
    ports:
      - ${CRANK_IMAGE_CLASSIFIER_GPU_HTTPS_PORT:-8400}:8400
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8400/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
  crank-image-classifier-cpu-dev:
    build:
      context: .
      dockerfile: image-classifier/Dockerfile
    container_name: crank-image-classifier-cpu-dev
    environment:
      - CRANK_ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - IMAGE_CLASSIFIER_HTTPS_PORT=8401
      - IMAGE_CLASSIFIER_SERVICE_NAME=crank-image-classifier-cpu-dev
      - CA_SERVICE_URL=https://crank-cert-authority-dev:9090
      - HTTPS_ONLY=true
      - PLATFORM_URL=https://crank-platform-dev:8443
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN:-local-dev-key}
    ports:
      - ${CRANK_IMAGE_CLASSIFIER_CPU_HTTPS_PORT:-8401}:8401
    volumes:
      - ./services:/app/services:ro
      - ./shared:/app/shared:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - -k
        - https://localhost:8401/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      crank-platform-dev:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - crank-local-net
networks:
  crank-local-net:
    driver: bridge
    name: crank-local-network
volumes:
  local-data:
    name: crank-local-data
  local-logs:
    name: crank-local-logs
